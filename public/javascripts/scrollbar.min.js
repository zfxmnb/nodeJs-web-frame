/* 使用该插件必须引用mousewheel.js
        CDN http://cdn.bootcss.com/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js
    */

if(!$("*").mousewheel)
document.write("<script src='http://cdn.bootcss.com/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js'></script>");

(function($){
    $.fn.scrollbar=function(options){
        
        var defaults={
            'width':'8px',
            'height':'8px',
            'pos':'right',
            'bgcolor':'#ccc',//滚动条背景
            'trumbcolor':'#666',//滚动条颜色
            'aopacity':1,//透明度
            'trackwidth':'10px',//滚动条宽度
            'speed':20,//滚动距离
            'radius':'5px',//圆角
            'autopadding':true,//是否自动增加padding
            'fixWidth':true,//是否固定宽度
            'autohide':false,//是否自动隐藏
            'autohideTime':2000,//自动隐藏时间
        };
        var ele=$(this);
        var settings=$.extend(defaults,options);
        var conHeight=ele[0].scrollHeight;
        var height=ele.height();
        var st=0,t;
        ele.on('DOMNodeInserted DOMNodeRemoveed',function(e){
            conHeight=ele[0].scrollHeight;
            height=ele.height();
            init();
            addDOM();
        });
        $(window).resize(function(){
            conHeight=ele[0].scrollHeight;
            height=ele.height();
            init();
            addDOM();
            if(conHeight<=height){
                ele.children(".scrollbar_track_y").hide();
            }
        });
        addDOM();
        function init(){
            ele.children(".scrollbar_track_y").children(".scrollbar_trumb_y").height(height*height/conHeight+"px");
        }
        function canSelect(){
            $("body").css({ 
                    "-webkit-user-select":"initial",
                    "-moz-user-select":"-moz-initial",
                    "-ms-user-select":"initial",
                    "-khtml-user-select":"initial",
                    "user-select":"initial"});
        }
        function cannotSelect(){
            $("body").css({
                "-webkit-user-select":"none",
                "-moz-user-select":"-moz-none",
                "-ms-user-select":"none",
                "-khtml-user-select":"none",
                "user-select":"none"});
        }
         function addDOM(){
            if(conHeight>height&&!ele.children(".scrollbar_track_y").length>0){
                var pr=parseInt(ele.css("padding-"+settings.pos));
                var p=settings.autopadding?(parseInt(settings.width)+pr):pr;
                var w=settings.fixWidth?parseInt(ele.css("width"))-parseInt(settings.width):parseInt(ele.css("width"));
                ele.css({
                    "overflow":"hidden",
                    "position":ele.css("position")?ele.css("position"):"relative",
                    "width":w+"px"
                });
                ele.append(
                    "<div class='scrollbar_track_y' style='position:absolute;'>"+
                        "<div class='scrollbar_trumb_y' style='position:absolute;cursor:pointer;'></div>"+
                    "</div>"
                    );
                    ele.children(".scrollbar_track_y").css({
                        "position":"absolute",
                        "transition":"opacity 0.3s",
                        "top":0,
                        "width":settings.width,
                        "height":"100%",
                        "border-radius":settings.radius,
                        "background":settings.bgcolor,
                        "opacity":settings.aopacity
                    });
                    ele.children(".scrollbar_track_y").children(".scrollbar_trumb_y").css({
                        "position":"absolute",
                        "top":0,
                        "width":settings.width,
                        "border-radius":settings.radius,
                        "background":settings.trumbcolor,
                        "opacity":settings.aopacity
                    });
                  if(settings.pos=="left"){
                    ele.css("padding-left",p+"px");
                    ele.children(".scrollbar_track_y").css("left","0")
                  }else{
                    ele.css("padding-right",p+"px");
                    ele.children(".scrollbar_track_y").css("right","0")
                  }
                opstions();
            }else{
                ele.children(".scrollbar_track_y").show();
            }
            autohide();
        }
        function autohide(){
            if(settings.autohide){
                clearTimeout(t);
                ele.children(".scrollbar_track_y").css("opacity",1);
                t=setTimeout(function(){
                    ele.children(".scrollbar_track_y").css("opacity",0);
                },settings.autohideTime);
            }
        }
         function opstions(){
            ele.mousewheel(function(event){
                    event.preventDefault();
                   autohide();
                    if(event.deltaY==-1){
                        ele.scrollTop(st=st+settings.speed>(conHeight-height)?(conHeight-height):st+settings.speed);
                    }
                    else{
                        ele.scrollTop(st=st-settings.speed<0?0:st-settings.speed);
                    }
                    ele.children(".scrollbar_track_y").children(".scrollbar_trumb_y").css("top",st*height/conHeight+"px");
                    ele.children(".scrollbar_track_x").css("bottom",-st+"px");
                    ele.children(".scrollbar_track_y").css("top",st+"px");
            });
            ele.children(".scrollbar_track_y").children(".scrollbar_trumb_y").off().on("mousedown",function(event){
                var yo=event.clientY;
                var s;
                cannotSelect();
                autohide();
                ele.on("mousemove",function(e){
                    autohide();
                    var yc=e.clientY;
                    var c=yc-yo;
                    s=st+c>0?(st+(c*conHeight/height)>(conHeight-height)?(conHeight-height):st+(c*conHeight/height))
                        :(st+(c*conHeight/height)<0?0:st+(c*conHeight/height));
                    ele.scrollTop(s);
                    ele.children(".scrollbar_track_y").children(".scrollbar_trumb_y").css("top",s*height/conHeight+"px");
                    ele.children(".scrollbar_track_y").css("top",s+"px");
                });
                ele.on("mouseup mouseleave",function(){
                    st=s;
                    ele.off("mousemove");
                    canSelect();
                });
            });
        }
    };
})(jQuery)